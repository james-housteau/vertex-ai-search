#!/usr/bin/env bash
# Git post-commit hook: Auto-organize files and clean trash after commits

set -euo pipefail

echo "üîÑ Running automatic file organization after commit..."

# Use CLAUDE_PROJECT_DIR if available, otherwise find the repository root
if [ -n "${CLAUDE_PROJECT_DIR:-}" ]; then
    repo_root="$CLAUDE_PROJECT_DIR"
elif repo_root=$(git rev-parse --show-toplevel 2>/dev/null); then
    : # repo_root already set
else
    echo "‚ö†Ô∏è  Not in a git repository - skipping organization"
    exit 0
fi

# Path to comprehensive organization script
organize_script="$repo_root/.genesis/scripts/utils/organize-all-files.sh"

if [ -f "$organize_script" ]; then
    # Run in auto mode (no prompts, removes trash automatically)
    cd "$repo_root" && "$organize_script" --auto

    # If files were organized, create auto-commit
    if git status --porcelain | grep -q '^'; then
        echo ""
        echo "üì¶ Files were auto-organized. Creating automatic commit..."
        git add .
        git commit -m "chore: auto-organize files and clean trash

Auto-organized by post-commit hook using organize-all-files.sh
- Moved misplaced files to proper directories
- Cleaned up trash files (backups, logs, duplicates)
- Maintained Genesis project structure standards" --no-verify
        echo "‚úÖ Auto-organization commit created"
    else
        echo "‚úÖ All files already properly organized"
    fi
else
    echo "‚ö†Ô∏è  Organization script not found at: $organize_script"
    echo "‚ö†Ô∏è  Skipping automatic organization"
fi

exit 0
